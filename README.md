# YRDatabase - è·¨æœæ•°æ®åº“ç®¡ç†ç³»ç»Ÿ

[![License](https://img.shields.io/badge/license-MIT-blue.svg)](LICENSE)
[![Java](https://img.shields.io/badge/Java-17-orange.svg)](https://www.oracle.com/java/)
[![Nukkit](https://img.shields.io/badge/Nukkit-1.0-green.svg)](https://github.com/CloudburstMC/Nukkit)
[![WaterdogPE](https://img.shields.io/badge/WaterdogPE-2.0-blue.svg)](https://github.com/WaterdogPE/WaterdogPE)

**YRDatabase** æ˜¯ä¸€ä¸ªä¸“ä¸ºMinecraftåŸºå²©ç‰ˆç½‘æ˜“æœåŠ¡å™¨è®¾è®¡çš„å¤šæ¨¡å—æ•°æ®åº“ç®¡ç†ç³»ç»Ÿï¼Œæ”¯æŒWaterdogPEä»£ç†å’ŒNukkitå­æœä¹‹é—´çš„æ™ºèƒ½æ•°æ®åŒæ­¥ã€‚

---

## âœ¨ æ ¸å¿ƒç‰¹æ€§

### ğŸ¯ æ™ºèƒ½ç©å®¶ä¼šè¯ç®¡ç†
- âœ… **ç²¾å‡†åŒºåˆ†**ï¼šçœŸå®åŠ å…¥/é€€å‡º vs å­æœè½¬æœ
- âœ… **Plugin Messaging**ï¼šåŸºäºæ ‡å‡†é€šä¿¡åè®®ï¼Œä½å»¶è¿Ÿï¼ˆ<10msï¼‰
- âœ… **è‡ªåŠ¨æŒä¹…åŒ–**ï¼šç©å®¶çœŸå®é€€å‡ºæ—¶è‡ªåŠ¨ä¿å­˜æ•°æ®
- âœ… **åˆå§‹åŒ–ä¼˜åŒ–**ï¼šè½¬æœæ—¶è·³è¿‡æ•°æ®åˆå§‹åŒ–ï¼Œå‡å°‘æ•°æ®åº“å‹åŠ›

### ğŸ—„ï¸ åŒæ•°æ®åº“æ¶æ„
- **Redis**ï¼šé«˜æ€§èƒ½ç¼“å­˜å±‚ï¼ˆLettuceå®¢æˆ·ç«¯ï¼‰
- **MySQL**ï¼šå¯é æŒä¹…åŒ–å±‚ï¼ˆHikariCPè¿æ¥æ± ï¼‰
- **æ™ºèƒ½API**ï¼šè‡ªåŠ¨ç¼“å­˜åŒæ­¥ã€æ‰¹é‡æ“ä½œã€åˆ†å¸ƒå¼é”

### ğŸ›¡ï¸ å®‰å…¨ä¸å¯é æ€§
- ğŸ”’ **æ¶ˆæ¯åŠ å¯†**ï¼šé­”æ•°éªŒè¯ã€CRC32æ ¡éªŒã€åè®®ç‰ˆæœ¬æ§åˆ¶
- â±ï¸ **è¶…æ—¶ä¿æŠ¤**ï¼š5åˆ†é’Ÿä¼šè¯è¶…æ—¶æ£€æµ‹
- ğŸ§µ **å¤šçº¿ç¨‹**ï¼šå¼‚æ­¥æŒä¹…åŒ–ã€å®ˆæŠ¤çº¿ç¨‹ç›‘æ§
- ğŸ“Š **å®Œå–„æ—¥å¿—**ï¼šè¯¦ç»†çš„äº‹ä»¶è¿½è¸ªå’Œè°ƒè¯•ä¿¡æ¯

---

## ğŸ“¦ é¡¹ç›®ç»“æ„

```
YRDatabase/
â”œâ”€â”€ yrdatabase-common/          # å…¬å…±æ¨¡å—
â”‚   â”œâ”€â”€ protocol/               # é€šä¿¡åè®®å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ MessageType.java    # æ¶ˆæ¯ç±»å‹æšä¸¾
â”‚   â”‚   â”œâ”€â”€ PluginMessage.java  # æ¶ˆæ¯æ•°æ®ç»“æ„
â”‚   â”‚   â”œâ”€â”€ MessageCodec.java   # ç¼–è§£ç å™¨ï¼ˆå«æ ¡éªŒï¼‰
â”‚   â”‚   â””â”€â”€ ProtocolConstants.java  # åè®®å¸¸é‡
â”‚   â””â”€â”€ session/                # ä¼šè¯ç®¡ç†
â”‚       â””â”€â”€ PlayerSession.java  # ç©å®¶ä¼šè¯å¯¹è±¡
â”‚
â”œâ”€â”€ yrdatabase-waterdog/        # WaterdogPEä»£ç†ç«¯æ’ä»¶
â”‚   â””â”€â”€ YRDatabaseWaterdog.java # ç›‘å¬çœŸå®åŠ å…¥/é€€å‡º
â”‚
â””â”€â”€ yrdatabase-nukkit/          # Nukkitå­æœç«¯æ’ä»¶
    â”œâ”€â”€ YRDatabase.java         # ä¸»æ’ä»¶ç±»ï¼ˆå«Plugin Messagingï¼‰
    â”œâ”€â”€ api/                    # æ•°æ®åº“APIæ¥å£
    â”œâ”€â”€ impl/                   # æ ¸å¿ƒå®ç°
    â”œâ”€â”€ mysql/                  # MySQLé©±åŠ¨
    â””â”€â”€ redis/                  # Redisé©±åŠ¨
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒè¦æ±‚

| ç»„ä»¶ | ç‰ˆæœ¬è¦æ±‚ |
|------|----------|
| Java | 17+ |
| WaterdogPE | 2.0+ |
| Nukkit | 1.0+ |
| Redis | 5.0+ (å¯é€‰) |
| MySQL | 8.0+ (å¯é€‰) |

### 2. ç¼–è¯‘é¡¹ç›®

```bash
git clone https://github.com/yirankuma/YRDatabase.git
cd YRDatabase
gradlew shadowJar
```

ç¼–è¯‘äº§ç‰©ï¼š
- `yrdatabase-waterdog/build/libs/YRDatabase-Waterdog.jar` â†’ éƒ¨ç½²åˆ°WaterdogPE
- `yrdatabase-nukkit/build/libs/YRDatabase.jar` â†’ éƒ¨ç½²åˆ°æ‰€æœ‰Nukkitå­æœ

### 3. éƒ¨ç½²æ­¥éª¤

#### 3.1 éƒ¨ç½²WaterdogPEæ’ä»¶

```bash
# 1. å°†æ’ä»¶æ”¾å…¥WaterdogPEçš„pluginsç›®å½•
cp YRDatabase-Waterdog.jar /path/to/WaterdogPE/plugins/

# 2. é‡å¯WaterdogPE
```

#### 3.2 éƒ¨ç½²Nukkitæ’ä»¶

```bash
# 1. å°†æ’ä»¶æ”¾å…¥æ¯ä¸ªNukkitå­æœçš„pluginsç›®å½•
cp YRDatabase.jar /path/to/Nukkit-Server1/plugins/
cp YRDatabase.jar /path/to/Nukkit-Server2/plugins/
# ... æ‰€æœ‰å­æœ

# 2. é…ç½®æ•°æ®åº“ï¼ˆconfig.jsonï¼‰
# 3. é‡å¯æ‰€æœ‰å­æœ
```

### 4. é…ç½®æ–‡ä»¶ (config.json)

```json
{
  "UseNeteaseUid": false,
  "redis": {
    "enabled": true,
    "host": "localhost",
    "port": 6379,
    "password": "",
    "database": 0,
    "timeout": 5000,
    "maxConnections": 20
  },
  "mysql": {
    "enabled": true,
    "host": "localhost",
    "port": 3306,
    "database": "yrdatabase",
    "username": "root",
    "password": "your_password",
    "timezone": "Asia/Shanghai",
    "maxPoolSize": 10,
    "minIdle": 2,
    "connectionTimeout": 30000,
    "idleTimeout": 600000,
    "maxLifetime": 1800000
  }
}
```

---

## ğŸ”§ å·¥ä½œåŸç†

### é€šä¿¡æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç©å®¶è¿æ¥   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WaterdogPE (ä»£ç†ç«¯)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ PlayerLoginEvent                    â”‚    â”‚
â”‚  â”‚ â”œâ”€ ç”ŸæˆREAL_JOINæ¶ˆæ¯                â”‚    â”‚
â”‚  â”‚ â””â”€ å¹¿æ’­åˆ°æ‰€æœ‰å­æœ (Plugin Channel)   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ Plugin Messaging
               â”‚ (yrdatabase:main)
               v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Nukkitå­æœ (Server1, Server2, ...)         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ PluginMessageListener                  â”‚  â”‚
â”‚  â”‚ â”œâ”€ æ¥æ”¶REAL_JOINæ¶ˆæ¯                   â”‚  â”‚
â”‚  â”‚ â”œâ”€ ç¼“å­˜ç©å®¶UIDåˆ°realOnlinePlayers      â”‚  â”‚
â”‚  â”‚ â””â”€ ç­‰å¾…PlayerJoinEvent...              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ PlayerJoinEvent                        â”‚  â”‚
â”‚  â”‚ â”œâ”€ æ£€æŸ¥realOnlinePlayersç¼“å­˜           â”‚  â”‚
â”‚  â”‚ â”œâ”€ å¦‚æœå­˜åœ¨ â†’ çœŸå®åŠ å…¥ â†’ åˆå§‹åŒ–æ•°æ®    â”‚  â”‚
â”‚  â”‚ â””â”€ å¦‚æœä¸å­˜åœ¨ â†’ è½¬æœ â†’ è·³è¿‡åˆå§‹åŒ–      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

       ç©å®¶åœ¨å­æœé—´æ¸¸ç©...
       (è½¬æœæ—¶ä¸è§¦å‘æŒä¹…åŒ–)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç©å®¶æ–­å¼€è¿æ¥ â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WaterdogPE (ä»£ç†ç«¯)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ PlayerDisconnectedEvent             â”‚    â”‚
â”‚  â”‚ â”œâ”€ ç”ŸæˆREAL_QUITæ¶ˆæ¯                â”‚    â”‚
â”‚  â”‚ â””â”€ å‘é€åˆ°ç©å®¶æœ€åæ‰€åœ¨å­æœ            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ Plugin Messaging
               v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Nukkitå­æœ                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ PluginMessageListener                  â”‚  â”‚
â”‚  â”‚ â”œâ”€ æ¥æ”¶REAL_QUITæ¶ˆæ¯                   â”‚  â”‚
â”‚  â”‚ â”œâ”€ ç§»é™¤realOnlinePlayersç¼“å­˜           â”‚  â”‚
â”‚  â”‚ â”œâ”€ åŠ å…¥æŒä¹…åŒ–é˜Ÿåˆ— (persistQueue)       â”‚  â”‚
â”‚  â”‚ â””â”€ åå°çº¿ç¨‹å¼‚æ­¥æŒä¹…åŒ–åˆ°MySQL           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®æ—¶åº

| æ—¶é—´ç‚¹ | äº‹ä»¶ | WaterdogPE | Nukkit | è¯´æ˜ |
|--------|------|------------|--------|------|
| T0 | ç©å®¶è¿æ¥ä»£ç† | å‘é€REAL_JOIN | æ¥æ”¶å¹¶ç¼“å­˜UID | æ ‡è®°çœŸå®åŠ å…¥ |
| T1 | ç©å®¶è¿›å…¥å­æœA | - | æ£€æµ‹åˆ°ç¼“å­˜ï¼Œåˆå§‹åŒ–æ•°æ® | ä»…é¦–æ¬¡åˆå§‹åŒ– |
| T2 | ç©å®¶è½¬æœAâ†’B | - | æœªæ”¶åˆ°REAL_JOINï¼Œè·³è¿‡ | ä¸æŒä¹…åŒ– |
| T3 | ç©å®¶æ–­å¼€è¿æ¥ | å‘é€REAL_QUIT | æ¥æ”¶å¹¶æŒä¹…åŒ– | è§¦å‘ä¿å­˜ |

---

## ğŸ“š APIä½¿ç”¨æŒ‡å—

### è·å–æ•°æ®åº“ç®¡ç†å™¨

```java
// åœ¨ä½ çš„æ’ä»¶ä¸­
DatabaseManager db = YRDatabase.getInstance().getDatabaseManager();
```

### åŸºç¡€æ“ä½œ

```java
// 1. å­˜å‚¨æ•°æ®
db.set("player:123:coins", "1000", 3600); // 1å°æ—¶è¿‡æœŸ

// 2. è¯»å–æ•°æ®
db.get("player:123:coins").thenAccept(value -> {
    getLogger().info("ç©å®¶é‡‘å¸: " + value);
});

// 3. åˆ é™¤æ•°æ®
db.delete("player:123:coins");
```

### æ™ºèƒ½APIï¼ˆè‡ªåŠ¨ç¼“å­˜+æŒä¹…åŒ–ï¼‰

```java
// è‡ªåŠ¨ç®¡ç†Redisç¼“å­˜å’ŒMySQLæŒä¹…åŒ–
db.smartSet("players", "123", Map.of(
    "name", "Steve",
    "level", 10,
    "coins", 1000
), 3600);

db.smartGet("players", "123").thenAccept(data -> {
    // ä¼˜å…ˆä»Redisè¯»å–ï¼Œç¼“å­˜æœªå‘½ä¸­æ—¶ä»MySQLåŠ è½½
    getLogger().info("ç©å®¶æ•°æ®: " + data);
});

// æŒä¹…åŒ–å¹¶æ¸…é™¤ç¼“å­˜
db.persistAndClearCache("players", "123");
```

### æ‰¹é‡æ“ä½œ

```java
List<String> keys = Arrays.asList("player:1", "player:2", "player:3");
db.smartBatchGet("players", keys).thenAccept(results -> {
    results.forEach((key, data) -> {
        getLogger().info(key + " -> " + data);
    });
});
```

---

## ğŸ® ç®¡ç†å‘½ä»¤

### WaterdogPEç«¯

æ— å‘½ä»¤ï¼ˆåå°è‡ªåŠ¨è¿è¡Œï¼‰

### Nukkitç«¯

```bash
# æŸ¥çœ‹è¿æ¥çŠ¶æ€
/yrdb status

# é‡è½½é…ç½®
/yrdb reload

# æŸ¥çœ‹ä¼šè¯ç¼“å­˜
/yrdb sessions

# æŸ¥çœ‹æŒä¹…åŒ–é˜Ÿåˆ—
/yrdb queue
```

---

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šNukkitæ”¶ä¸åˆ°REAL_JOINæ¶ˆæ¯

**ç—‡çŠ¶**ï¼šæ‰€æœ‰ç©å®¶åŠ å…¥éƒ½è¢«è®¤ä¸ºæ˜¯è½¬æœ

**æ’æŸ¥æ­¥éª¤**ï¼š
1. æ£€æŸ¥WaterdogPEæ’ä»¶æ˜¯å¦åŠ è½½æˆåŠŸ
2. æ£€æŸ¥Nukkitæ—¥å¿—æ˜¯å¦æœ‰"Plugin Messaging å·²æ³¨å†Œ"
3. ä½¿ç”¨ `/yrdb sessions` æŸ¥çœ‹ç¼“å­˜æ˜¯å¦ä¸ºç©º
4. ç¡®è®¤WaterdogPEå’ŒNukkitä¹‹é—´çš„ç½‘ç»œè¿æ¥æ­£å¸¸

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# WaterdogPEæ—¥å¿—åº”æ˜¾ç¤ºï¼š
[INFO] ç©å®¶çœŸå®åŠ å…¥: Steve (UID: 123456789)
[INFO] å·²å¹¿æ’­REAL_JOINæ¶ˆæ¯åˆ° 3 ä¸ªå­æœ

# Nukkitæ—¥å¿—åº”æ˜¾ç¤ºï¼š
[INFO] æ”¶åˆ°REAL_JOINæ¶ˆæ¯: Steve (UID: 123456789)
```

### é—®é¢˜2ï¼šæ•°æ®æœªæŒä¹…åŒ–

**ç—‡çŠ¶**ï¼šç©å®¶é€€å‡ºåæ•°æ®ä¸¢å¤±

**æ’æŸ¥æ­¥éª¤**ï¼š
1. æŸ¥çœ‹æŒä¹…åŒ–é˜Ÿåˆ—ï¼š`/yrdb queue`
2. æ£€æŸ¥MySQLè¿æ¥çŠ¶æ€ï¼š`/yrdb status`
3. æŸ¥çœ‹Nukkitæ—¥å¿—ä¸­çš„"ç©å®¶æ•°æ®å·²æŒä¹…åŒ–"æ¶ˆæ¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# ç¡®ä¿æ”¶åˆ°REAL_QUITæ¶ˆæ¯
[INFO] æ”¶åˆ°REAL_QUITæ¶ˆæ¯: Steve (UID: 123456789, æœ€åæœåŠ¡å™¨: lobby)
[INFO] ç©å®¶æ•°æ®å·²æŒä¹…åŒ–: UID=123456789
```

### é—®é¢˜3ï¼šè½¬æœæ—¶æ•°æ®è¢«é‡å¤åˆå§‹åŒ–

**ç—‡çŠ¶**ï¼šç©å®¶è½¬æœæ—¶æ•°æ®è¢«é‡ç½®

**åŸå› **ï¼šå¯èƒ½æ˜¯ç¼“å­˜è¿‡æœŸï¼ˆé»˜è®¤60ç§’ï¼‰

**è§£å†³æ–¹æ¡ˆ**ï¼š
- è°ƒæ•´ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼ˆä¿®æ”¹YRDatabase.javaç¬¬137è¡Œï¼‰
- æˆ–ä½¿ç”¨Redis Pub/Subæ–¹æ¡ˆï¼ˆæ›´å¯é ï¼‰

---

## ğŸ”’ å®‰å…¨æœºåˆ¶

### 1. æ¶ˆæ¯æ ¡éªŒ
- **é­”æ•°éªŒè¯**ï¼š0x59524442 ("YRDB")
- **åè®®ç‰ˆæœ¬**ï¼šç¡®ä¿å…¼å®¹æ€§
- **CRC32æ ¡éªŒå’Œ**ï¼šé˜²æ­¢æ•°æ®æŸå
- **æ¶ˆæ¯è¿‡æœŸæ£€æµ‹**ï¼šä¸¢å¼ƒè¶…è¿‡30ç§’çš„æ¶ˆæ¯

### 2. è¶…æ—¶ä¿æŠ¤
- **ä¼šè¯è¶…æ—¶**ï¼š5åˆ†é’Ÿæœªæ”¶åˆ°å¿ƒè·³è‡ªåŠ¨æ¸…ç†
- **æŒä¹…åŒ–è¶…æ—¶**ï¼š10ç§’å†…æœªå®Œæˆåˆ™è®°å½•è­¦å‘Š
- **å®ˆæŠ¤çº¿ç¨‹**ï¼šæ¯30ç§’æ£€æŸ¥å¼‚å¸¸ä¼šè¯

### 3. å¼‚å¸¸å¤„ç†
- æ•°æ®åº“è¿æ¥å¤±è´¥è‡ªåŠ¨é‡è¯•
- æŒä¹…åŒ–å¤±è´¥è®°å½•æ—¥å¿—ä½†ä¸ä¸­æ–­æœåŠ¡
- WaterdogPEå´©æºƒæ—¶Nukkitè‡ªåŠ¨é™çº§å¤„ç†

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. å‡å°‘æ•°æ®åº“å‹åŠ›
- âœ… è½¬æœä¸è§¦å‘æŒä¹…åŒ–ï¼ˆæ ¸å¿ƒä¼˜åŒ–ï¼‰
- âœ… å¼‚æ­¥æ‰¹é‡æ“ä½œ
- âœ… Redisç¼“å­˜å±‚å‡å°‘MySQLæŸ¥è¯¢

### 2. å¹¶å‘å¤„ç†
- 2ä¸ªæŒä¹…åŒ–å·¥ä½œçº¿ç¨‹
- æ— é”é˜Ÿåˆ—ï¼ˆLinkedBlockingQueueï¼‰
- Guavaç¼“å­˜ï¼ˆé«˜æ€§èƒ½ï¼‰

### 3. å†…å­˜ç®¡ç†
- ç¼“å­˜60ç§’è‡ªåŠ¨è¿‡æœŸ
- æœ€å¤§ç¼“å­˜10000ä¸ªä¼šè¯
- è½¯å¼•ç”¨é¿å…OOM

---

## ğŸ› ï¸ å¼€å‘è€…æŒ‡å—

### æ‰©å±•æ¶ˆæ¯ç±»å‹

```java
// 1. åœ¨MessageTypeä¸­æ·»åŠ æ–°ç±»å‹
public enum MessageType {
    // ...
    CUSTOM_EVENT((byte) 0x10);
}

// 2. åœ¨WaterdogPEå‘é€æ¶ˆæ¯
PluginMessage message = PluginMessage.builder(MessageType.CUSTOM_EVENT)
    .put("data", "value")
    .build();
byte[] data = MessageCodec.encode(message);
serverInfo.sendPluginMessage(ProtocolConstants.MAIN_CHANNEL, data);

// 3. åœ¨Nukkitå¤„ç†æ¶ˆæ¯
case CUSTOM_EVENT:
    handleCustomEvent(uid, message);
    break;
```

### é›†æˆç½‘æ˜“UID

åœ¨ `YRDatabaseWaterdog.java` çš„ `getPlayerUid()` æ–¹æ³•ä¸­ï¼š

```java
private long getPlayerUid(ProxiedPlayer player) {
    // ä»WaterdogPEçš„LoginDataè·å–ç½‘æ˜“UID
    // å…·ä½“å®ç°å–å†³äºWaterdogPE_Neteaseçš„API

    // ç¤ºä¾‹ï¼ˆä¼ªä»£ç ï¼‰ï¼š
    LoginData loginData = player.getLoginData();
    if (loginData.hasExtraData("netease_uid")) {
        return loginData.getExtraData("netease_uid").asLong();
    }

    // Fallback: ä½¿ç”¨UUID
    return player.getUniqueId().getMostSignificantBits()
        ^ player.getUniqueId().getLeastSignificantBits();
}
```

---

## ğŸ“ TODO

- [ ] é›†æˆçœŸå®çš„ç½‘æ˜“UIDè·å–é€»è¾‘
- [ ] æ·»åŠ Redis Pub/Subä½œä¸ºå¤‡é€‰é€šä¿¡æ–¹æ¡ˆ
- [ ] å®ç°åˆ†å¸ƒå¼é”é˜²æ­¢å¹¶å‘å†™å…¥å†²çª
- [ ] æ·»åŠ Prometheusç›‘æ§æŒ‡æ ‡
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡è¾¾åˆ°80%

---

## ğŸ¤ è´¡çŒ®æŒ‡å—

æ¬¢è¿æäº¤Issueå’ŒPull Requestï¼

1. Forkæœ¬ä»“åº“
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯ (`git checkout -b feature/AmazingFeature`)
3. æäº¤æ›´æ”¹ (`git commit -m 'Add some AmazingFeature'`)
4. æ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/AmazingFeature`)
5. æ‰“å¼€Pull Request

---

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨MITè®¸å¯è¯ - è¯¦è§ [LICENSE](LICENSE) æ–‡ä»¶

---

## ğŸ‘¤ ä½œè€…

**YiranKuma**

- GitHub: [@yirankuma](https://github.com/yirankuma)

---

## ğŸ™ è‡´è°¢

- [WaterdogPE](https://github.com/WaterdogPE/WaterdogPE) - ä¼˜ç§€çš„ä»£ç†æœåŠ¡å™¨
- [Nukkit](https://github.com/CloudburstMC/Nukkit) - å¼ºå¤§çš„åŸºå²©ç‰ˆæœåŠ¡å™¨
- [MCNeteaseDevs](https://github.com/MCNeteaseDevs) - ç½‘æ˜“ç‰ˆé€‚é…æ”¯æŒ

---

**â­ å¦‚æœè¿™ä¸ªé¡¹ç›®å¯¹ä½ æœ‰å¸®åŠ©ï¼Œè¯·ç»™æˆ‘ä¸€ä¸ªStarï¼**
