# YRDatabase 配置说明

## 快速配置指南

### 配置文件位置

**WaterdogPE插件**：
```
WaterdogPE/plugins/YRDatabase-Waterdog/config.json
```

**Nukkit插件**：
```
Nukkit/plugins/YRDatabase/config.json
```

---

## 配置格式统一

两个插件现在使用完全相同的JSON配置格式！

### WaterdogPE配置（config.json）

```json
{
  "redis": {
    "enabled": true,
    "host": "localhost",
    "port": 6379,
    "password": "",
    "database": 0,
    "timeout": 5000
  }
}
```

### Nukkit配置（config.json）

```json
{
  "UseNeteaseUid": false,
  "redis": {
    "enabled": true,
    "host": "localhost",
    "port": 6379,
    "password": "",
    "database": 0,
    "timeout": 5000,
    "maxConnections": 20
  },
  "mysql": {
    "enabled": true,
    "host": "localhost",
    "port": 3306,
    "database": "yrdatabase",
    "username": "root",
    "password": "your_password",
    "timezone": "Asia/Shanghai",
    "maxPoolSize": 10,
    "minIdle": 2,
    "connectionTimeout": 30000,
    "idleTimeout": 600000,
    "maxLifetime": 1800000
  }
}
```

---

## 快速复制配置

如果你已经配置好了Nukkit的Redis，可以直接复制Redis配置部分到WaterdogPE：

1. 打开Nukkit的配置文件：`plugins/YRDatabase/config.json`
2. 复制`redis`部分（从`"redis": {`到对应的`}`）
3. 粘贴到WaterdogPE的配置文件中

示例：
```json
// Nukkit配置
{
  "UseNeteaseUid": false,
  "redis": {              // ← 复制这部分
    "enabled": true,
    "host": "192.168.1.100",
    "port": 6379,
    "password": "mypassword",
    "database": 0,
    "timeout": 5000,
    "maxConnections": 20
  },                      // ← 到这里
  "mysql": { ... }
}

// 粘贴到WaterdogPE配置
{
  "redis": {              // ← 粘贴到这里
    "enabled": true,
    "host": "192.168.1.100",
    "port": 6379,
    "password": "mypassword",
    "database": 0,
    "timeout": 5000
  }
}
```

---

## 配置项说明

### Redis配置

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `enabled` | boolean | true | 是否启用Redis |
| `host` | string | "localhost" | Redis服务器地址 |
| `port` | int | 6379 | Redis端口 |
| `password` | string | "" | Redis密码（留空表示无密码） |
| `database` | int | 0 | Redis数据库编号 |
| `timeout` | int | 5000 | 连接超时时间（毫秒） |
| `maxConnections` | int | 20 | 最大连接数（仅Nukkit） |

### MySQL配置（仅Nukkit）

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `enabled` | boolean | true | 是否启用MySQL |
| `host` | string | "localhost" | MySQL服务器地址 |
| `port` | int | 3306 | MySQL端口 |
| `database` | string | "yrdatabase" | 数据库名 |
| `username` | string | "root" | 用户名 |
| `password` | string | "" | 密码 |
| `timezone` | string | "Asia/Shanghai" | 时区 |
| `maxPoolSize` | int | 10 | 最大连接池大小 |
| `minIdle` | int | 2 | 最小空闲连接数 |
| `connectionTimeout` | long | 30000 | 连接超时时间（毫秒） |
| `idleTimeout` | long | 600000 | 空闲超时时间（毫秒） |
| `maxLifetime` | long | 1800000 | 最大生命周期（毫秒） |

---

## 配置要点

### 必须相同的配置

**WaterdogPE和Nukkit的以下配置必须相同**：
- ✅ `redis.host` - 必须指向同一个Redis服务器
- ✅ `redis.port` - 端口必须相同
- ✅ `redis.password` - 密码必须相同（如果有）
- ✅ `redis.database` - 数据库编号必须相同

### 可以不同的配置

- ⭕ `redis.timeout` - 可以不同
- ⭕ `redis.maxConnections` - WaterdogPE没有此配置

---

## 常见配置场景

### 场景1：本地开发环境

Redis和服务器都在本地：

**WaterdogPE和Nukkit都使用**：
```json
{
  "redis": {
    "enabled": true,
    "host": "localhost",
    "port": 6379,
    "password": "",
    "database": 0,
    "timeout": 5000
  }
}
```

### 场景2：独立Redis服务器

Redis在独立服务器上（例如192.168.1.100）：

**WaterdogPE和Nukkit都使用**：
```json
{
  "redis": {
    "enabled": true,
    "host": "192.168.1.100",
    "port": 6379,
    "password": "",
    "database": 0,
    "timeout": 5000
  }
}
```

### 场景3：有密码的Redis

Redis设置了密码保护：

**WaterdogPE和Nukkit都使用**：
```json
{
  "redis": {
    "enabled": true,
    "host": "localhost",
    "port": 6379,
    "password": "your_redis_password_here",
    "database": 0,
    "timeout": 5000
  }
}
```

### 场景4：使用不同的Redis数据库

如果你的Redis有多个应用，可以使用不同的database编号：

**WaterdogPE和Nukkit都使用**：
```json
{
  "redis": {
    "enabled": true,
    "host": "localhost",
    "port": 6379,
    "password": "",
    "database": 1,  // ← 使用database 1而不是0
    "timeout": 5000
  }
}
```

### 场景5：禁用Redis Pub/Sub

如果不想使用跨服通信功能：

**WaterdogPE和Nukkit都使用**：
```json
{
  "redis": {
    "enabled": false,  // ← 禁用
    "host": "localhost",
    "port": 6379,
    "password": "",
    "database": 0,
    "timeout": 5000
  }
}
```

**影响**：
- 玩家转服时会触发持久化
- 数据库压力增加
- 但基础功能仍可使用

---

## 配置检查清单

部署前检查：

- [ ] 两个配置文件的`redis.host`相同
- [ ] 两个配置文件的`redis.port`相同
- [ ] 两个配置文件的`redis.password`相同
- [ ] 两个配置文件的`redis.database`相同
- [ ] Redis服务器正在运行
- [ ] 可以从服务器连接到Redis（使用`redis-cli`测试）
- [ ] Nukkit的MySQL配置正确（如果使用MySQL）

---

## 修改配置后如何生效

### WaterdogPE插件

修改配置后需要重启WaterdogPE服务器：
```bash
# 停止服务器
# 修改 plugins/YRDatabase-Waterdog/config.json
# 启动服务器
```

### Nukkit插件

修改配置后可以使用命令重载：
```bash
yrdb reload
```

或者重启Nukkit服务器。

---

## 配置验证

### 检查WaterdogPE配置是否正确

启动WaterdogPE后，查看日志：

✅ **正确**：
```log
[INFO] 配置文件加载成功
[INFO] Redis: 已启用
[INFO] Redis连接成功: localhost:6379
```

❌ **错误**：
```log
[ERROR] Redis连接失败: Connection refused
```

### 检查Nukkit配置是否正确

在Nukkit控制台执行：
```bash
yrdb status
```

✅ **正确**：
```
=== YRDatabase 状态 ===
Redis 状态: 已连接
MySQL 状态: 已连接
Redis Pub/Sub: 已启用
真实在线玩家数: 0
```

❌ **错误**：
```
Redis 状态: 未连接
Redis Pub/Sub: 未启用
```

---

## 常见问题

### Q: 我只修改了一个配置文件，为什么不工作？

**A**: 两个插件的Redis配置必须完全一致！如果只修改了一个，消息无法正确传递。

### Q: 我可以让WaterdogPE和Nukkit使用不同的Redis服务器吗？

**A**: 不可以！它们必须使用同一个Redis服务器才能通信。

### Q: maxConnections配置在哪里？

**A**: 只有Nukkit有这个配置，WaterdogPE不需要。

### Q: 配置文件格式错误怎么办？

**A**:
1. 检查JSON格式是否正确（使用在线JSON验证工具）
2. 检查是否有多余的逗号
3. 检查引号是否成对
4. 删除配置文件让插件重新生成默认配置

---

## 配置模板

### 最简配置（本地开发）

**WaterdogPE config.json**：
```json
{
  "redis": {
    "enabled": true,
    "host": "localhost",
    "port": 6379,
    "password": "",
    "database": 0,
    "timeout": 5000
  }
}
```

**Nukkit config.json**：
```json
{
  "UseNeteaseUid": false,
  "redis": {
    "enabled": true,
    "host": "localhost",
    "port": 6379,
    "password": "",
    "database": 0,
    "timeout": 5000,
    "maxConnections": 20
  },
  "mysql": {
    "enabled": true,
    "host": "localhost",
    "port": 3306,
    "database": "yrdatabase",
    "username": "root",
    "password": "changeme",
    "timezone": "Asia/Shanghai",
    "maxPoolSize": 10,
    "minIdle": 2,
    "connectionTimeout": 30000,
    "idleTimeout": 600000,
    "maxLifetime": 1800000
  }
}
```

### 生产环境配置

**WaterdogPE config.json**：
```json
{
  "redis": {
    "enabled": true,
    "host": "redis.example.com",
    "port": 6379,
    "password": "strong_password_here",
    "database": 1,
    "timeout": 10000
  }
}
```

**Nukkit config.json**：
```json
{
  "UseNeteaseUid": false,
  "redis": {
    "enabled": true,
    "host": "redis.example.com",
    "port": 6379,
    "password": "strong_password_here",
    "database": 1,
    "timeout": 10000,
    "maxConnections": 50
  },
  "mysql": {
    "enabled": true,
    "host": "mysql.example.com",
    "port": 3306,
    "database": "yrdatabase_prod",
    "username": "yrdatabase_user",
    "password": "strong_mysql_password",
    "timezone": "Asia/Shanghai",
    "maxPoolSize": 20,
    "minIdle": 5,
    "connectionTimeout": 30000,
    "idleTimeout": 600000,
    "maxLifetime": 1800000
  }
}
```

---

**配置完成后，参考 [REDIS_PUBSUB_COMPLETE.md](REDIS_PUBSUB_COMPLETE.md) 进行部署测试。**
